<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€è¨ˆåˆ†å™¨ - å‹•æ£®é¢¨æ ¼</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN (for score trend chart) --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* ========================================= */
        /* ACNH STYLE VARIABLES & CORE STYLES */
        /* ========================================= */
        :root {
            /* ACNH Color Palette */
            --color-sky-blue: #BBE1F4; /* èƒŒæ™¯å¤©ç©º/æµ·æ´‹ */
            --color-grass-green: #97CE66; /* ä¸»è¦è¡Œå‹• (ç¶ è‰²è‰åœ°) */
            --color-accent-yellow: #FAD36E; /* äº®é»ƒè‰² (é“å…·/é‡è¦è¨Šæ¯) */
            --color-earth-brown: #C9A27F; /* å¡ç‰‡é‚Šæ¡†/æœ¨é ­ */
            --color-text-dark: #4A4A4A; /* æ·±è‰²æ–‡å­— */
            --color-text-light: #6A6A6A; /* æ·ºè‰²æ–‡å­— */
            --color-modal-bg: #FFFFFF; /* æ¨¡æ…‹æ¡†èƒŒæ™¯ */
            --color-score-card: #FFF8E1; /* åˆ†æ•¸å¡ç‰‡èƒŒæ™¯ (å¥¶æ²¹è‰²) */
            --color-plus: #4CAF50; /* åŠ åˆ†ç¶  */
            --color-minus: #F44336; /* æ¸›åˆ†ç´… */
            --color-button-shadow-green: #7BAA4E;
            --color-button-shadow-yellow: #D1A45D;
            --color-button-shadow-blue: #5B81B3;
            --color-button-shadow-red: #D32F2F;
            --color-button-shadow-setting: #A0AEC0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-sky-blue);
            color: var(--color-text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 10px;
            touch-action: manipulation;
        }

        /* ä¸»å®¹å™¨æ¨£å¼ (å³¶å¶¼å‘Šç¤ºæ¿/å¡ç‰‡) */
        .acnh-card {
            background-color: white;
            border-radius: 40px; /* æ¥µåº¦åœ“æ½¤ */
            padding: 2.5rem 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 0 0 4px var(--color-earth-brown); /* é›™å±¤é™°å½± */
            max-width: 95%;
            width: 700px;
        }

        /* æ¨™é¡Œ (åƒå³¶å¶¼åç¨±) */
        h1 {
            color: var(--color-grass-green);
            font-weight: 800;
            text-shadow: 2px 2px 0 #FFF; /* ç™½è‰²æé‚Šæ•ˆæœ */
        }

        /* å‹•ç‰©æ£®å‹æœƒé¢¨æ ¼æŒ‰éˆ• (åœ“é‚Šä¸”æœ‰æµ®å‡¸æ„Ÿ) */
        .acnh-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            min-width: 130px; /* ç¢ºä¿åœ¨ç§»å‹•ç«¯æœ‰è¶³å¤ é»æ“Šå€åŸŸ */
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 9999px; /* æ¥µåœ“é‚Š */
            cursor: pointer;
            transition: all 0.1s ease-out;
            color: white;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
        }
        
        /* åŸºç¤æŒ‰éˆ•å‹•ç•« */
        .acnh-button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .acnh-button:active {
            transform: translateY(3px); /* æŒ‰ä¸‹æ™‚å‘ä¸‹ç§»å‹• */
            box-shadow: 0 2px 0 0 !important; /* é™°å½±è®Šå° */
        }
        
        .acnh-button:disabled {
            filter: grayscale(0.8);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 5px 0 0 rgba(0, 0, 0, 0.1) !important;
            background-color: #B0B0B0 !important;
        }

        /* é»ƒè‰²æŒ‰éˆ• (Reset) */
        .acnh-button.yellow {
            background-color: var(--color-accent-yellow);
            box-shadow: 0 5px 0 0 var(--color-button-shadow-yellow);
        }
        .acnh-button.yellow:hover {
            box-shadow: 0 7px 0 0 var(--color-button-shadow-yellow);
        }

        /* ç¶ è‰²æŒ‰éˆ• (Add Score) */
        .acnh-button.green-main {
            background-color: var(--color-grass-green);
            box-shadow: 0 5px 0 0 var(--color-button-shadow-green);
        }
        .acnh-button.green-main:hover {
            box-shadow: 0 7px 0 0 var(--color-button-shadow-green);
        }
        
        /* è—è‰²æŒ‰éˆ• (Setup Names) */
        .acnh-button.blue-main {
            background-color: #79A3D3;
            box-shadow: 0 5px 0 0 var(--color-button-shadow-blue);
        }
        .acnh-button.blue-main:hover {
            box-shadow: 0 7px 0 0 var(--color-button-shadow-blue);
        }

        /* ç°è‰²æŒ‰éˆ• (Settings/Cancel) */
        .acnh-button.gray-main {
            background-color: #A0AEC0;
            box-shadow: 0 5px 0 0 #718096;
        }
        .acnh-button.gray-main:hover {
            box-shadow: 0 7px 0 0 #718096;
        }

        /* ç´…è‰²æŒ‰éˆ• (Gang Actions) */
        .acnh-button.red-gang {
            background-color: #FF7043; /* æ·ºæ©™ç´… */
            box-shadow: 0 5px 0 0 #D84315;
            min-width: 110px;
        }
        .acnh-button.red-gang:hover {
            box-shadow: 0 7px 0 0 #D84315;
        }
        
        /* åˆ†æ•¸å¡ç‰‡æ¨£å¼ */
        .score-card {
            background-color: var(--color-score-card);
            border-radius: 20px;
            box-shadow: 0 4px 0 0 #D3C9AD; /* æ·ºæ£•è‰²åº•éƒ¨é™°å½± */
            transition: transform 0.2s;
        }
        .score-card:hover {
            transform: translateY(-2px);
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal-content {
            background-color: var(--color-modal-bg);
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        /* æ¶ˆé™¤ input æ•¸å­—ç®­é ­ */
        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinners {
            -moz-appearance: textfield;
        }

        /* ========================================= */
        /* FIREBASE & CORE LOGIC (START) */
        /* ========================================= */
    </style>
    <!-- Firebase Imports --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase Log Level
        setLogLevel('Debug');
        
        // --- START: CONFIGURATION & ENVIRONMENT HANDLING ---
        const DEFAULT_PLAYER_NAMES = ['å³¶æ°‘A', 'å³¶æ°‘B', 'å³¶æ°‘C', 'å³¶æ°‘D'];
        
        const CANVAS_FALLBACK_CONFIG = {
            apiKey: "AIzaSyAucSfEkaiVy4fo26owposx2WUGIDEkSPQ",
            authDomain: "kiwimj.firebaseapp.com",
            projectId: "kiwimj",
            storageBucket: "kiwimj.firebaseapp.com",
            messagingSenderId: "909819524840",
            appId: "1:909819524840:web:67cc2c9b7c03bb10827b5d",
            measurementId: "G-6HVF2N100E"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : CANVAS_FALLBACK_CONFIG;
            
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- END: CONFIGURATION & ENVIRONMENT HANDLING ---

        let db, auth;
        let userId = null;

        // --- Application State ---
        const createDefaultPlayers = () => DEFAULT_PLAYER_NAMES.map((name, index) => ({
            id: index,
            name: name,
            score: 0
        }));
        
        let players = createDefaultPlayers();
        let gameHistory = [];
        
        // --- NEW: Chart Instance ---
        let scoreChartInstance = null; // Global variable for Chart instance
        
        // --- NEW: Gang Score Multipliers ---
        const GANG_MULTIPLIERS = {
            kai: 6, // é–‹æ§“: 6 * step (1 pays 1)
            ming: 6, // æ˜æ§“: 6 * step (3 pay 2 * step)
            an: 12 // æš—æ§“: 12 * step (3 pay 4 * step)
        };
        
        /** æ ¹æ“šæ­¥é•·è¨ˆç®—é è¨­çš„æ§“åˆ† */
        function getDefaultGangScores(step = 1) {
            return {
                stepValue: step,
                mingGangTotal: GANG_MULTIPLIERS.ming * step,
                anGangTotal: GANG_MULTIPLIERS.an * step,
                kaiGangTotal: GANG_MULTIPLIERS.kai * step,
            };
        }
        
        // è¨­å®šç‹€æ…‹ (ä½¿ç”¨æ­¥é•· 1 çš„é è¨­å€¼åˆå§‹åŒ–)
        let settings = getDefaultGangScores(1);
        
        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜é–‹æ§“æµç¨‹ä¸­çš„æ”¶éŒ¢è€… ID
        let currentKaiGangReceiverId = null;
        
        // --- DOM Elements ---
        const scoreDisplay = document.getElementById('score-display');
        const roundInputsContainer = document.getElementById('round-inputs-container');
        const roundTotalChange = document.getElementById('round-total-change');
        const historyList = document.getElementById('history-list');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // --- Core Utility Functions (Exposed to window for inline events) ---

        /** èª¿æ•´åˆ†æ•¸è®Šå‹•å€¼ä¸¦é‡æ–°è¨ˆç®—ç¸½å’Œ */
        function adjustChange(playerId, amount) {
            const input = document.getElementById(`change-${playerId}`);
            if (input) {
                let currentValue = parseInt(input.value || 0, 10);
                currentValue += amount;
                input.value = currentValue;
                calculateRoundTotal();
            }
        }

        /** è¨ˆç®—å›åˆç¸½è®Šå‹•ï¼Œä¸¦æ§åˆ¶ç¢ºèªæŒ‰éˆ•ç‹€æ…‹ (ç”¨æ–¼è‡ªå®šç¾©çµç®—) */
        function calculateRoundTotal() {
            let total = 0;
            players.forEach(player => {
                const input = document.getElementById(`change-${player.id}`);
                if (input) {
                    total += parseInt(input.value || 0, 10);
                }
            });
            
            // æ›´æ–°ç¸½è®Šå‹•æ–‡å­—ï¼Œæä¾›ä¸Šä¸‹æ–‡
            roundTotalChange.textContent = `åˆ†æ•¸ç¸½è®Šå‹•: ${total}`;

            const confirmBtn = document.getElementById('confirm-round-btn');
            
            // ACNH Style color for text
            if (total === 0) {
                roundTotalChange.classList.remove('text-red-600');
                roundTotalChange.classList.add('text-green-600');
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'acnh-button-disabled');
            } else {
                roundTotalChange.classList.remove('text-green-600');
                roundTotalChange.classList.add('text-red-600');
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed', 'acnh-button-disabled');
            }
        }
        
        /** è‡ªæ‘¸çµç®— - è¼¸å…¥åˆ†æ•¸æ™‚è‡ªå‹•è¨ˆç®—ä¸‰å®¶å¹³å‡åˆ†é…é¡ */
        function calculateHuSplit(winnerId) {
            const paymentInput = document.getElementById('hu-split-total');
            const confirmBtn = document.getElementById('confirm-hu-split-btn');
            const errorMsg = document.getElementById('hu-split-error');
            
            // IMPORTANT: è¼¸å…¥å€¼æ˜¯æ¯ä½è¼¸å®¶æ”¯ä»˜çš„åˆ†æ•¸ (X)
            const paymentPerPlayer = parseInt(paymentInput.value || 0, 10);
            
            // é‡ç½®
            errorMsg.classList.add('hidden');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');

            if (paymentPerPlayer <= 0 || isNaN(paymentPerPlayer)) {
                errorMsg.textContent = 'è«‹è¼¸å…¥æ¯ä½è¼¸å®¶æ”¯ä»˜çš„æ­£æ•¸é‡‘é¡ã€‚';
                errorMsg.classList.remove('hidden');
                return;
            }
            
            // è´å®¶æ”¶åˆ°ç¸½é¡ (3 * X)
            const winnerTotal = paymentPerPlayer * 3;
            
            const loserNames = players.filter(p => p.id !== winnerId).map(p => p.name).join('ã€');
            
            errorMsg.textContent = `çµç®—é è¦½ï¼šè´å®¶ç²å¾— +${winnerTotal} åˆ†ã€‚è¼¸å®¶ (${loserNames}) æ¯äººæ”¯ä»˜ -${paymentPerPlayer} åˆ†ã€‚ç¸½è®Šå‹•ï¼š0`;
            errorMsg.classList.remove('text-red-600');
            errorMsg.classList.add('text-green-600');
            errorMsg.classList.remove('hidden');

            confirmBtn.disabled = false;
            confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }


        window.adjustChange = adjustChange;
        window.calculateRoundTotal = calculateRoundTotal;
        window.calculateHuSplit = calculateHuSplit;
        window.showModal = showModal;
        window.hideModal = hideModal;
        window.handleThreePayFixedTransaction = handleThreePayFixedTransaction;
        window.openCustomRoundModal = openCustomRoundModal;


        // --- Initialization and Authentication ---

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration is missing.");
                    alertMessage('éŒ¯èª¤: ç¼ºå°‘ Firebase é…ç½®ã€‚ç„¡æ³•å„²å­˜è³‡æ–™ã€‚', 'red');
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 

                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with Custom Token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in Anonymously (using fallback config).");
                    }
                } catch (e) {
                    console.error("Firebase Sign-In Failed:", e);
                    alertMessage('éŒ¯èª¤: ç„¡æ³•å»ºç«‹ç”¨æˆ¶æœƒè©±ã€‚è«‹æª¢æŸ¥ Firebase å°ˆæ¡ˆè¨­å®šã€‚', 'red');
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated user ID:", userId);
                        // ACNH Style text for ID
                        userIdDisplay.innerHTML = `<span class="text-sm">æˆ‘çš„å³¶å¶¼è™Ÿç¢¼ (å…±äº«éµ): </span><span class="font-mono text-xs break-all">${userId}</span>`;
                        setupRealtimeListener();
                    } else {
                        console.log("User state changed to signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                alertMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'red');
            }
        }

        // --- Firestore Operations ---

        function getGameDocRef() {
            if (!db) return null;
            return doc(db, 'artifacts', appId, 'public', 'data', 'mahjongScores', 'current_game');
        }

        function setupRealtimeListener() {
            const gameRef = getGameDocRef();
            if (!gameRef) return;

            onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Load state
                    players = data.players || players;
                    gameHistory = data.history || gameHistory;
                    
                    // NEW: Ensure settings defaults are applied if loaded data is partial
                    const loadedSettings = data.settings || {};
                    const currentStep = loadedSettings.stepValue || settings.stepValue; // Use existing step if not loaded
                    settings = {
                        ...getDefaultGangScores(currentStep), // Apply defaults for the current step
                        ...loadedSettings, // Overwrite with loaded data
                    };
                    
                    renderUI();
                    
                    // Re-render round inputs to use new stepValue
                    const roundModal = document.getElementById('custom-round-modal');
                    if (roundModal && !roundModal.classList.contains('hidden')) {
                         renderCustomRoundInputs();
                    }
                } else {
                    saveGameState();
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                alertMessage(`æ•¸æ“šåŒæ­¥å¤±æ•—: ${error.message}`, 'red');
            });
        }

        async function saveGameState() {
            const gameRef = getGameDocRef();
            if (!gameRef || !userId) {
                if (auth.currentUser) {
                    alertMessage('éŒ¯èª¤: å°šæœªå®Œæˆèº«ä»½é©—è­‰ï¼Œç„¡æ³•å„²å­˜ã€‚', 'red');
                }
                return;
            }

            const stateToSave = {
                players: players,
                history: gameHistory,
                settings: settings,
                lastUpdated: new Date().toISOString(),
                ownerId: userId
            };

            try {
                await setDoc(gameRef, stateToSave, { merge: true });
            } catch (e) {
                console.error("Error saving document: ", e);
                alertMessage(`å„²å­˜å¤±æ•—: ${e.message}`, 'red');
            }
        }

        // --- UI Rendering Functions ---

        function renderUI() {
            if (scoreDisplay) renderScores();
            if (historyList) renderHistory();
            renderSettingsInputs();
        }

        function renderScores() {
            if (!scoreDisplay) return;
            scoreDisplay.innerHTML = players.map(player => `
                <div class="score-card p-4 flex justify-between items-center transition duration-300">
                    <div class="text-lg font-semibold text-var-text-dark">${player.name}</div>
                    <div id="score-${player.id}" class="text-3xl font-bold" style="color: ${player.score >= 0 ? 'var(--color-plus)' : 'var(--color-minus)'};">
                        ${player.score}
                    </div>
                </div>
            `).join('');
        }
        
        function renderSettingsInputs() {
            const unitSelect = document.getElementById('setting-step-value');
            const mingGangInput = document.getElementById('setting-ming-gang');
            const anGangInput = document.getElementById('setting-an-gang');
            const kaiGangInput = document.getElementById('setting-kai-gang');

            if (unitSelect) unitSelect.value = settings.stepValue;
            if (mingGangInput) mingGangInput.value = settings.mingGangTotal;
            if (anGangInput) anGangInput.value = settings.anGangTotal;
            if (kaiGangInput) kaiGangInput.value = settings.kaiGangTotal;
            
            // --- NEW: Dynamic default update based on step value in modal ---
            if (unitSelect && mingGangInput && anGangInput && kaiGangInput) {
                // Remove previous listener to prevent duplication
                unitSelect.onchange = null; 
                
                unitSelect.onchange = () => {
                    const newStep = parseInt(unitSelect.value, 10);
                    if (isNaN(newStep)) return;

                    const defaults = getDefaultGangScores(newStep);

                    // Update gang score inputs to the new defaults
                    mingGangInput.value = defaults.mingGangTotal;
                    anGangInput.value = defaults.anGangTotal;
                    kaiGangInput.value = defaults.kaiGangTotal;
                };
            }
        }

        /** æ¸²æŸ“ è‡ªå®šç¾©åˆ†æ•¸è®Šå‹• æ¨¡æ…‹æ¡†çš„è¼¸å…¥æ¬„ä½ */
        function renderCustomRoundInputs() {
            const LOCAL_STEP = settings.stepValue || 1;
            
            roundInputsContainer.innerHTML = players.map(player => `
                <div class="flex items-center space-x-2 mb-4">
                    <label class="w-1/3 text-lg font-semibold text-var-text-dark">${player.name}</label>
                    <div class="w-2/3 flex items-center bg-gray-100 border border-gray-300 rounded-lg overflow-hidden shadow-inner">
                        <!-- Minus Button --><button onclick="window.adjustChange(${player.id}, -${LOCAL_STEP})" 
                                type="button" 
                                class="w-1/4 h-12 bg-red-400 hover:bg-red-500 text-white font-bold text-xl transition duration-150 active:scale-[0.95]">
                            -
                        </button>
                        <!-- Input Field --><input type="number" id="change-${player.id}" value="0" placeholder="Â± è®Šå‹•"
                               class="w-2/4 text-center px-2 py-1 bg-gray-100 text-var-text-dark font-bold text-xl no-spinners focus:outline-none" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd;">
                        <!-- Plus Button --><button onclick="window.adjustChange(${player.id}, ${LOCAL_STEP})" 
                                type="button" 
                                class="w-1/4 h-12 bg-green-400 hover:bg-green-500 text-white font-bold text-xl transition duration-150 active:scale-[0.95]">
                            +
                        </button>
                    </div>
                </div>
            `).join('');
            
            players.forEach(player => {
                const inputEl = document.getElementById(`change-${player.id}`);
                if (inputEl) {
                    inputEl.addEventListener('input', calculateRoundTotal);
                }
            });
            calculateRoundTotal();
        }

        /** æ¸²æŸ“ 3 å®¶ä»˜å¸³çš„æ”¶éŒ¢è€…é¸æ“‡æŒ‰éˆ• (é€šç”¨æ–¼ æ˜æ§“/æš—æ§“) */
        function renderThreePayActionButtons(type, scoreKey, gangTitle, icon) {
            const container = document.getElementById('gang-action-buttons');
            if (!container) return;
            container.innerHTML = players.map(player => `
                <button onclick="window.handleThreePayFixedTransaction('${type}', '${scoreKey}', ${player.id})" 
                        class="acnh-button blue-main w-full py-2">
                    ${icon} ${player.name} (æ”¶éŒ¢)
                </button>
            `).join('');
            
            document.getElementById('gang-action-title').textContent = `${gangTitle} - èª°æ”¶éŒ¢ (3 å®¶ä»˜)ï¼Ÿ`;
            showModal('gang-action-modal');
        }


        function renderHistory() {
            if (!historyList) return;
            historyList.innerHTML = '';
            if (gameHistory.length === 0) {
                historyList.innerHTML = '<p class="text-center py-4" style="color: var(--color-text-light);">é‚„æ²’æœ‰å°å±€ç´€éŒ„å–”ï¼Œå¿«ä¾†ç©å§ï¼</p>';
                return;
            }

            gameHistory.slice(0, 10).reverse().forEach((round, index) => {
                const roundIndex = gameHistory.length - index;
                const date = new Date(round.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                let title;
                let titleClass;
                let detail;
                
                if (round.type === 'custom') {
                    // è‡ªå®šç¾©åˆ†æ•¸è®Šå‹•
                    const totalChange = round.changes.reduce((sum, c) => sum + c.change, 0);
                    title = `âœ… è¤‡é›œçµç®—/è‡ªå®šç¾©è®Šå‹• (ç¸½é¡: ${totalChange})`;
                    titleClass = 'text-yellow-600';
                    detail = round.changes.map(change => `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-b-0">
                            <span style="color: var(--color-text-light);">${players.find(p => p.id === change.playerId)?.name || 'æœªçŸ¥ç©å®¶'}</span>
                            <span class="font-medium" style="color: ${change.change >= 0 ? 'var(--color-plus)' : 'var(--color-minus)'};">
                                ${change.change > 0 ? '+' : ''}${change.change}
                            </span>
                        </div>
                    `).join('');
                } else if (round.type === 'hu-split') {
                    // è‡ªæ‘¸çµç®— (1 æ”¶ 3 å¹³å‡ä»˜)
                    const winnerChange = round.changes.find(c => c.change > 0);
                    const winnerName = players.find(p => p.id === winnerChange?.playerId)?.name || 'æœªçŸ¥è´å®¶';
                    const totalScore = round.totalScore; // è´å®¶ç¸½æ”¶ (3X)
                    const payment = round.paymentPerPlayer; // æ¯å®¶æ”¯ä»˜ (X)

                    title = `ğŸ¯ ${winnerName} è‡ªæ‘¸çµç®— (æ¯å®¶ä»˜ ${payment}ï¼Œç¸½æ”¶ ${totalScore})`;
                    titleClass = 'text-green-600 font-extrabold';
                    detail = round.changes.map(change => `
                        <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-b-0">
                            <span style="color: var(--color-text-light);">${players.find(p => p.id === change.playerId)?.name || 'æœªçŸ¥ç©å®¶'}</span>
                            <span class="font-medium" style="color: ${change.change >= 0 ? 'var(--color-plus)' : 'var(--color-minus)'};">
                                ${change.change > 0 ? '+' : ''}${change.change}
                            </span>
                        </div>
                    `).join('');
                } else if (round.type === 'gang') {
                    // æ§“åˆ†çµç®—
                    const receiver = players.find(p => p.id === round.kongMakerId)?.name || 'æœªçŸ¥ç©å®¶';
                    
                    if (round.paymentType === '1pays3') {
                        // Fixed Ming/An Gang (1 æ”¶ 3 ä»˜)
                        const totalScore = round.changes.find(c => c.change > 0).change;
                        const scorePerPlayer = totalScore / 3;
                        
                        title = `${round.gangType} (${receiver} æ”¶ ${totalScore}) æ§“åˆ†`;
                        detail = `<div class="text-sm text-gray-500 mb-1">å…¶é¤˜ä¸‰å®¶å„ä»˜ ${scorePerPlayer} åˆ† (å›ºå®š)</div>` + 
                                 round.changes.map(change => `
                            <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-b-0">
                                <span style="color: var(--color-text-light);">${players.find(p => p.id === change.playerId)?.name || 'æœªçŸ¥ç©å®¶'}</span>
                            <span class="font-medium" style="color: ${change.change >= 0 ? 'var(--color-plus)' : 'var(--color-minus)'};">
                                ${change.change > 0 ? '+' : ''}${change.change}
                            </span>
                        </div>
                    `).join('');
                        titleClass = 'text-red-500 font-extrabold';
                        
                    } else if (round.paymentType === '1pays1') {
                         // Fixed Kai Gang (1 æ”¶ 1 ä»˜)
                         const payer = players.find(p => p.id === round.payerId)?.name || 'æœªçŸ¥ç©å®¶';
                         const score = round.changes.find(c => c.change > 0).change;
                         title = `${round.gangType} (${receiver} æ”¶ ${score}) æ§“åˆ†`;
                         detail = `<div class="text-sm text-gray-500 mb-1">${payer} å–®ç¨æ”¯ä»˜ ${score} åˆ† (å›ºå®š)</div>` +
                                  round.changes.map(change => `
                            <div class="flex justify-between text-sm py-1 border-b border-gray-200 last:border-b-0">
                                <span style="color: var(--color-text-light);">${players.find(p => p.id === change.playerId)?.name || 'æœªçŸ¥ç©å®¶'}</span>
                                <span class="font-medium" style="color: ${change.change >= 0 ? 'var(--color-plus)' : 'var(--color-minus)'};">
                                    ${change.change > 0 ? '+' : ''}${change.change}
                                </span>
                            </div>
                        `).join('');
                        titleClass = 'text-red-500 font-extrabold';
                    }
                }


                // ACNH Style history item
                historyList.innerHTML += `
                    <li class="bg-gray-50 p-3 rounded-xl mb-3 border-l-4 border-yellow-500 shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-bold ${titleClass}">${title}</span>
                            <span class="text-xs" style="color: var(--color-text-light);">${date}</span>
                        </div>
                        <div class="mt-2 space-y-1">
                            ${detail}
                        </div>
                    </li>
                `;
            });
        }
        
        // --- NEW: Chart Logic ---

        /**
         * è™•ç† gameHistoryï¼Œè¨ˆç®—æ¯å€‹ç©å®¶åœ¨æ¯å›åˆçµæŸæ™‚çš„ç´¯ç©åˆ†æ•¸ã€‚
         * @returns {object} åŒ…å« labels (å›åˆæ•¸) å’Œ datasets (ç©å®¶èµ°å‹¢) çš„ Chart.js æ•¸æ“šçµæ§‹ã€‚
         */
        function generateChartData() {
            const playerScores = players.map(p => ({
                id: p.id,
                name: p.name,
                scores: [0] // å¾ 0 åˆ†é–‹å§‹
            }));

            // æ¨¡æ“¬åˆ†æ•¸è®Šå‹•
            let currentScores = players.reduce((acc, p) => {
                acc[p.id] = 0;
                return acc;
            }, {});

            gameHistory.forEach((round, index) => {
                // ç¢ºä¿æ¯å€‹ç©å®¶åœ¨å›åˆä¸­éƒ½æœ‰è®Šå‹•è¨˜éŒ„ï¼Œå³ä½¿è®Šå‹•ç‚º 0
                const roundChanges = players.map(p => {
                    const changeObj = round.changes.find(c => c.playerId === p.id);
                    return {
                        playerId: p.id,
                        change: changeObj ? changeObj.change : 0
                    };
                });
                
                roundChanges.forEach(change => {
                    currentScores[change.playerId] += change.change;
                });

                playerScores.forEach(pScore => {
                    pScore.scores.push(currentScores[pScore.id]);
                });
            });

            // ç”¢ç”Ÿæ¨™ç±¤ (å¾ "é–‹å§‹" åˆ° "ç¬¬ N å›åˆ")
            const labels = ["é–‹å§‹"].concat(gameHistory.map((_, index) => `ç¬¬ ${index + 1} å›åˆ`));

            // éš¨æ©Ÿé¡è‰²ç”Ÿæˆå™¨ (ä½¿ç”¨å››ç¨®é¡è‰²)
            const colors = [
                '#1f77b4', // Blue
                '#ff7f0e', // Orange
                '#2ca02c', // Green
                '#d62728', // Red
            ];

            const datasets = playerScores.map((pScore, index) => ({
                label: pScore.name,
                data: pScore.scores,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '40', // Semi-transparent fill
                tension: 0.2, // æ›²ç·šå¹³æ»‘åº¦
                fill: false, // ä¸å¡«å……å€åŸŸ
                pointRadius: 5,
                pointHoverRadius: 7
            }));

            return { labels, datasets };
        }

        /** æ¸²æŸ“ Chart.js åœ–è¡¨ */
        function renderScoreChart() {
            const chartData = generateChartData();
            const ctx = document.getElementById('score-chart');

            if (!ctx) return;

            if (scoreChartInstance) {
                scoreChartInstance.destroy(); // éŠ·æ¯€èˆŠå¯¦ä¾‹
            }
            
            // ACNH style: simple, rounded lines
            scoreChartInstance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ç´¯ç©ç¸½åˆ†'
                            }
                        },
                        x: {
                            // --- START: éš±è— X è»¸æ¨™ç±¤èˆ‡æ¨™é¡Œ ---
                            display: true, // ä¿æŒè»¸ç·šé¡¯ç¤º
                            ticks: {
                                display: false // éš±è—æ‰€æœ‰åˆ»åº¦æ¨™ç±¤
                            },
                            title: {
                                display: false // éš±è— X è»¸æ¨™é¡Œ
                            },
                            grid: {
                                drawOnChartArea: true, // ä»ç„¶é¡¯ç¤ºå‚ç›´ç¶²æ ¼ç·š
                            }
                            // --- END: éš±è— X è»¸æ¨™ç±¤èˆ‡æ¨™é¡Œ ---
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            bodyFont: {
                                family: 'Inter, sans-serif'
                            }
                        }
                    }
                }
            });
        }
        
        // --- Core Logic Functions ---
        
        /** è™•ç† 1 æ”¶ 3 ä»˜ äº¤æ˜“ (æ˜æ§“/æš—æ§“) - åƒ…ç”¨æ–¼å›ºå®šåˆ†æ•¸ */
        function handleThreePayFixedTransaction(type, scoreKey, receiverId) {
            hideModal('gang-action-modal');

            const totalScore = settings[scoreKey];
            const typeName = scoreKey === 'mingGangTotal' ? 'æ˜æ§“' : 'æš—æ§“';

            if (!totalScore || totalScore <= 0) {
                 alertMessage(`è«‹å…ˆåœ¨è¨­å®šä¸­é…ç½® ${typeName} çš„ç¸½åˆ†æ•¸ï¼`, 'red');
                 return;
            }
            
            if (totalScore % 3 !== 0) {
                 alertMessage(`éŒ¯èª¤: ${typeName} ç¸½åˆ† (${totalScore}) å¿…é ˆæ˜¯ 3 çš„å€æ•¸ï¼Œæ‰èƒ½å¹³å‡åˆ†é…çµ¦ 3 ä½ç©å®¶ï¼`, 'red');
                 return;
            }

            const paymentPerPlayer = totalScore / 3;
            const changes = [];
            
            const newPlayers = players.map(player => {
                let change = 0;
                if (player.id === receiverId) {
                    // æ”¶éŒ¢è€…
                    change = totalScore;
                } else {
                    // å…¶ä»–ä¸‰å®¶ä»˜éŒ¢
                    change = -paymentPerPlayer;
                }
                
                changes.push({ playerId: player.id, change: change });
                
                return {
                    ...player,
                    score: player.score + change
                };
            });
            
            players = newPlayers;

            const roundRecord = {
                type: type, // 'gang'
                gangType: typeName,
                paymentType: '1pays3',
                kongMakerId: receiverId, 
                timestamp: new Date().toISOString(),
                changes: changes
            };
            gameHistory.push(roundRecord);

            saveGameState();
            alertMessage(`${players.find(p => p.id === receiverId).name} æˆåŠŸåŸ·è¡Œ ${typeName}ï¼`, 'green');
        }
        
        /** é–‹å•Ÿè‡ªå®šç¾©åˆ†æ•¸è®Šå‹•æ¨¡æ…‹æ¡† */
        function openCustomRoundModal() {
            // æ¯æ¬¡é–‹å•Ÿè‡ªå®šç¾©æ¨¡å¼ï¼Œæ¸…é™¤è¼¸å…¥æ¬„ä½
            players.forEach(player => {
                const input = document.getElementById(`change-${player.id}`);
                if (input) input.value = 0;
            });
            
            renderCustomRoundInputs();
            showModal('custom-round-modal');
        }

        /** åŸ·è¡Œè‡ªå®šç¾©åˆ†æ•¸è®Šå‹•çµç®— */
        function applyCustomRoundScores() {
            const changes = [];
            players.forEach(player => {
                const input = document.getElementById(`change-${player.id}`);
                const change = parseInt(input.value || 0, 10);
                changes.push({ playerId: player.id, change: change });
            });

            const totalChange = changes.reduce((sum, item) => sum + item.change, 0);

            if (totalChange !== 0) {
                alertMessage('éŒ¯èª¤: ç©åˆ†ç¸½è®Šå‹•å¿…é ˆç‚ºé›¶ï¼', 'red');
                return; 
            }

            const newPlayers = players.map(player => {
                const changeObj = changes.find(c => c.playerId === player.id);
                return {
                    ...player,
                    score: player.score + changeObj.change
                };
            });
            players = newPlayers;

            const roundRecord = {
                type: 'custom',
                timestamp: new Date().toISOString(),
                changes: changes
            };
            gameHistory.push(roundRecord);

            // Reset inputs
            players.forEach(player => {
                const input = document.getElementById(`change-${player.id}`);
                if (input) input.value = 0;
            });

            saveGameState();
            hideModal('custom-round-modal');
            alertMessage('è‡ªå®šç¾©åˆ†æ•¸å·²æˆåŠŸçµç®—ï¼', 'green');
        }
        
        // --- è‡ªæ‘¸çµç®— (1 æ”¶ 3 å¹³å‡ä»˜) é‚è¼¯ ---
        
        /** è‡ªæ‘¸çµç®— Step 1: é¸æ“‡è´å®¶ */
        window.openHuSplitSelection = () => {
            const container = document.getElementById('hu-split-buttons');
            if (!container) return;
            
            container.innerHTML = players.map(player => `
                <button onclick="window.openHuSplitInput(${player.id})" 
                        class="acnh-button green-main w-full py-2">
                    ğŸ¯ ${player.name} (è‡ªæ‘¸è€…)
                </button>
            `).join('');
            
            document.getElementById('hu-split-title').textContent = `ğŸ¯ è‡ªæ‘¸çµç®— - èª°è‡ªæ‘¸ï¼Ÿ`;
            showModal('hu-split-selection-modal');
        }
        
        /** è‡ªæ‘¸çµç®— Step 2: è¼¸å…¥åˆ†æ•¸ä¸¦è¨ˆç®— */
        window.openHuSplitInput = (winnerId) => {
            hideModal('hu-split-selection-modal');
            
            const winnerName = players.find(p => p.id === winnerId)?.name || 'æœªçŸ¥ç©å®¶';
            
            document.getElementById('hu-split-input-title').textContent = `ğŸ¯ è‡ªæ‘¸çµç®— - ${winnerName} æ¯å®¶æ”¶å¤šå°‘ï¼Ÿ`;
            document.getElementById('hu-split-form').dataset.winnerId = winnerId;
            
            // æ¸…é™¤ä¸Šæ¬¡çš„è¼¸å…¥å’Œè¨Šæ¯
            document.getElementById('hu-split-total').value = '';
            document.getElementById('hu-split-error').classList.add('hidden');
            document.getElementById('confirm-hu-split-btn').disabled = true;
            document.getElementById('confirm-hu-split-btn').classList.add('opacity-50', 'cursor-not-allowed');
            
            showModal('hu-split-input-modal');
        }
        
        /** åŸ·è¡Œè‡ªæ‘¸çµç®— */
        window.applyHuSplitScores = (event) => {
            event.preventDefault();
            
            const form = document.getElementById('hu-split-form');
            const winnerId = parseInt(form.dataset.winnerId, 10);
            // NOW the input is the payment per player (X)
            const paymentPerPlayer = parseInt(document.getElementById('hu-split-total').value, 10);

            if (paymentPerPlayer <= 0 || isNaN(paymentPerPlayer)) {
                 alertMessage('éŒ¯èª¤: æ¯ä½ç©å®¶æ”¯ä»˜åˆ†æ•¸å¿…é ˆæ˜¯æ­£æ•¸ï¼', 'red');
                 return;
            }
            
            // Winner receives 3 * X
            const totalScoreReceived = paymentPerPlayer * 3; 
            const changes = [];
            
            const newPlayers = players.map(player => {
                let change = 0;
                if (player.id === winnerId) {
                    // è´å®¶æ”¶åˆ°ç¸½é¡
                    change = totalScoreReceived;
                } else {
                    // å…¶ä»–ä¸‰å®¶å„ä»˜ X
                    change = -paymentPerPlayer;
                }
                
                changes.push({ playerId: player.id, change: change });
                
                return {
                    ...player,
                    score: player.score + change
                };
            });
            
            players = newPlayers;

            const roundRecord = {
                type: 'hu-split',
                winnerId: winnerId,
                paymentPerPlayer: paymentPerPlayer, // è¨˜éŒ„æ¯å®¶æ”¯ä»˜çš„åˆ†æ•¸ (X)
                totalScore: totalScoreReceived, // è¨˜éŒ„è´å®¶ç¸½æ”¶çš„åˆ†æ•¸ (3X)
                timestamp: new Date().toISOString(),
                changes: changes
            };
            gameHistory.push(roundRecord);

            saveGameState();
            hideModal('hu-split-input-modal');
            alertMessage(`${players.find(p => p.id === winnerId).name} è‡ªæ‘¸çµç®—å®Œæˆï¼æ¯å®¶æ”¶ +${paymentPerPlayer} åˆ†ã€‚`, 'green');
        }

        // --- å…¶ä»–å·¥å…·å‡½æ•¸ (åç¨±è¨­å®šã€é‡è¨­ã€æ§“åˆ†) ä¿æŒä¸è®Š ---
        
        function savePlayerNames() {
            let namesChanged = false;
            const newPlayers = players.map(player => {
                const input = document.getElementById(`name-${player.id}`);
                const newName = input.value.trim() || DEFAULT_PLAYER_NAMES[player.id];
                if (player.name !== newName) {
                    namesChanged = true;
                }
                return { ...player, name: newName };
            });
            players = newPlayers;

            if (namesChanged) {
                saveGameState();
                alertMessage('å³¶æ°‘åç¨±å·²å„²å­˜ï¼', 'green');
            }
            hideModal('setup-modal');
        }
        
        function saveSettings() {
            const stepValue = parseInt(document.getElementById('setting-step-value').value, 10);
            const mingGangTotal = parseInt(document.getElementById('setting-ming-gang').value, 10);
            const anGangTotal = parseInt(document.getElementById('setting-an-gang').value, 10);
            const kaiGangTotal = parseInt(document.getElementById('setting-kai-gang').value, 10);
            
            if (isNaN(stepValue) || isNaN(mingGangTotal) || isNaN(anGangTotal) || isNaN(kaiGangTotal)) {
                alertMessage('éŒ¯èª¤: è¨­å®šå€¼å¿…é ˆæ˜¯æ•¸å­—ï¼', 'red');
                return;
            }
            
            if (mingGangTotal % 3 !== 0 || anGangTotal % 3 !== 0) {
                 alertMessage('éŒ¯èª¤: æ˜æ§“ã€æš—æ§“ç¸½åˆ†å¿…é ˆæ˜¯ 3 çš„å€æ•¸ï¼Œä»¥ç¢ºä¿ä¸‰å®¶ä»˜å¸³æ™‚èƒ½å¹³å‡åˆ†é…ï¼', 'red');
                 return;
            }
            
            settings = {
                stepValue: stepValue,
                mingGangTotal: mingGangTotal,
                anGangTotal: anGangTotal,
                kaiGangTotal: kaiGangTotal,
            };
            
            saveGameState();
            renderCustomRoundInputs(); 
            alertMessage('éŠæˆ²è¨­å®šå·²å„²å­˜ï¼', 'green');
            hideModal('settings-modal');
        }
        window.saveSettings = saveSettings;


        function resetGame() {
            const input = document.getElementById('reset-verification-input');
            if (input) {
                input.value = '';
            }
            showModal('reset-confirm-modal');
        }

        function performReset() {
            const verificationInput = document.getElementById('reset-verification-input');
            const requiredPhrase = "HELLO KIWI";

            if (!verificationInput || verificationInput.value.trim() !== requiredPhrase) {
                alertMessage(`å®‰å…¨é©—è­‰å¤±æ•—ï¼šæ‚¨å¿…é ˆè¼¸å…¥ "${requiredPhrase}" æ‰èƒ½é‡è¨­éŠæˆ²ã€‚`, 'red');
                verificationInput.value = '';
                return;
            }

            players = createDefaultPlayers();
            gameHistory = [];
            // é‡è¨­è¨­å®šå€¼ï¼Œä½¿ç”¨æ­¥é•· 1 çš„é è¨­å€¼
            settings = getDefaultGangScores(1); 
            saveGameState();
            alertMessage('å³¶å¶¼å·²é‡å•Ÿï¼æ‰€æœ‰ç´€éŒ„å·²æ¸…ç©ºã€‚', 'green');
            hideModal('reset-confirm-modal');
        }
        
        // --- Utility Functions (Modals & Alerts) ---

        function showModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('hidden');
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.add('hidden');
        }

        function alertMessage(message, type) {
            const container = document.getElementById('alert-container');
            if (!container) return;
            
            // ACNH Style colors for alerts
            const colorClass = type === 'red' ? 'bg-red-500' : 'bg-green-500';

            const alertEl = document.createElement('div');
            alertEl.className = `p-3 rounded-full text-white font-medium ${colorClass} shadow-xl mb-2 transition-opacity duration-300`;
            alertEl.textContent = message;

            container.appendChild(alertEl);

            setTimeout(() => {
                alertEl.classList.add('opacity-0');
                alertEl.addEventListener('transitionend', () => alertEl.remove());
            }, 3000);
        }

        // --- Event Listeners and Initial Load ---
        window.onload = () => {
            initializeFirebase();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const openHuSplitBtn = document.getElementById('open-hu-split-selection');
            const openCustomRoundBtn = document.getElementById('open-custom-round-modal');
            const openSetupBtn = document.getElementById('open-setup-modal');
            const openSettingsBtn = document.getElementById('open-settings-modal'); 
            const confirmCustomRoundBtn = document.getElementById('confirm-round-btn');
            const saveNamesBtn = document.getElementById('save-names-btn');
            const resetGameBtn = document.getElementById('reset-game-btn');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');
            
            // NEW Chart Button
            const openChartModalBtn = document.getElementById('open-chart-modal-btn');
            
            // Gang Action Buttons
            const openMingGangBtn = document.getElementById('open-ming-gang-btn');
            const openAnGangBtn = document.getElementById('open-an-gang-btn');
            const openKaiGangBtn = document.getElementById('open-kai-gang-btn'); 
            
            // Add Hu Split Listener
            if (openHuSplitBtn) openHuSplitBtn.addEventListener('click', window.openHuSplitSelection);
            
            // Use unified function for custom round
            if (openCustomRoundBtn) openCustomRoundBtn.addEventListener('click', window.openCustomRoundModal);
            
            if (openSetupBtn) openSetupBtn.addEventListener('click', () => {
                // Inline implementation for setup modal
                const container = document.getElementById('setup-inputs-container');
                if (!container) return;
                container.innerHTML = players.map(player => `
                    <div class="mb-4">
                        <label for="name-${player.id}" class="block text-sm font-medium text-var-text-light">å³¶æ°‘ ${player.id + 1} åç¨±</label>
                        <input type="text" id="name-${player.id}" value="${player.name}"
                            class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 sm:text-lg">
                    </div>
                `).join('');
                showModal('setup-modal');
            });
            
            if (openSettingsBtn) openSettingsBtn.addEventListener('click', () => {
                renderSettingsInputs();
                showModal('settings-modal');
            });
            
            // NEW Chart Button Listener
            if (openChartModalBtn) {
                openChartModalBtn.addEventListener('click', () => {
                    showModal('chart-modal');
                    // Delay rendering slightly to ensure modal is visible and canvas has dimensions
                    setTimeout(renderScoreChart, 100); 
                });
            }
            
            if (confirmCustomRoundBtn) confirmCustomRoundBtn.addEventListener('click', applyCustomRoundScores);
            if (saveNamesBtn) saveNamesBtn.addEventListener('click', savePlayerNames);
            
            if (resetGameBtn) resetGameBtn.addEventListener('click', resetGame); 
            if (confirmResetBtn) confirmResetBtn.addEventListener('click', performReset);
            
            // Gang Modal Button Listeners
            if (openMingGangBtn) openMingGangBtn.addEventListener('click', () => renderThreePayActionButtons('gang', 'mingGangTotal', 'æ˜æ§“', 'âšª'));
            if (openAnGangBtn) openAnGangBtn.addEventListener('click', () => renderThreePayActionButtons('gang', 'anGangTotal', 'æš—æ§“', 'âš«'));
            // Kai Gang is complex, using the previous 3-step approach
            window.openKaiGangReceiverSelection = () => {
                currentKaiGangReceiverId = null; // é‡ç½®ç‹€æ…‹
                const container = document.getElementById('gang-action-buttons');
                if (!container) return;
                
                container.innerHTML = players.map(player => `
                    <button onclick="window.handleKaiGangReceiverSelected(${player.id})" 
                            class="acnh-button green-main w-full py-2">
                        âœ¨ ${player.name} (æ”¶éŒ¢)
                    </button>
                `).join('');
                
                document.getElementById('gang-action-title').textContent = `é–‹æ§“ (1 æ”¶ 1 ä»˜) - èª°æ”¶éŒ¢ï¼Ÿ`;
                showModal('gang-action-modal');
            }
            if (openKaiGangBtn) openKaiGangBtn.addEventListener('click', window.openKaiGangReceiverSelection); 
            
            // Simplified Kai Gang Logic (Kept outside for brevity)
            window.handleKaiGangReceiverSelected = (receiverId) => {
                currentKaiGangReceiverId = receiverId;
                hideModal('gang-action-modal'); 
                const receiverName = players.find(p => p.id === receiverId)?.name || 'æœªçŸ¥ç©å®¶';
                document.getElementById('kai-gang-payer-title').textContent = `âœ¨ é–‹æ§“ - èª°ä»˜éŒ¢çµ¦ ${receiverName}ï¼Ÿ`;
                const container = document.getElementById('kai-gang-payer-buttons');
                if (!container) return;
                container.innerHTML = players.map(player => `
                    <button onclick="window.handleKaiGangTransaction(${receiverId}, ${player.id})" 
                            class="acnh-button red-gang w-full py-2 ${player.id === receiverId ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${player.id === receiverId ? 'disabled' : ''}>
                        ${player.id === receiverId ? 'ğŸš« ' : 'ğŸ’¸ '} ${player.name} (ä»˜éŒ¢)
                    </button>
                `).join('');
                showModal('kai-gang-payer-modal');
            }
            window.handleKaiGangTransaction = (receiverId, payerId) => {
                hideModal('kai-gang-payer-modal');
                currentKaiGangReceiverId = null;
                const score = settings.kaiGangTotal;
                if (!score || score <= 0) { alertMessage(`è«‹å…ˆåœ¨è¨­å®šä¸­é…ç½® é–‹æ§“ çš„ç¸½åˆ†ï¼`, 'red'); return; }
                const changes = [];
                const newPlayers = players.map(player => {
                    let change = 0;
                    if (player.id === receiverId) { change = score; } 
                    else if (player.id === payerId) { change = -score; }
                    changes.push({ playerId: player.id, change: change });
                    return { ...player, score: player.score + change };
                });
                players = newPlayers;
                const roundRecord = {
                    type: 'gang',
                    gangType: 'é–‹æ§“',
                    paymentType: '1pays1',
                    kongMakerId: receiverId, 
                    payerId: payerId,
                    timestamp: new Date().toISOString(),
                    changes: changes
                };
                gameHistory.push(roundRecord);
                saveGameState();
                alertMessage(`${players.find(p => p.id === receiverId).name} æˆåŠŸé–‹æ§“ï¼ç”± ${players.find(p => p.id === payerId).name} æ”¯ä»˜ ${score} åˆ†ã€‚`, 'green');
            }
            
            // Close modal listeners
            document.querySelectorAll('.close-modal-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalId = e.target.closest('.modal')?.id;
                    if (modalId) hideModal(modalId);
                });
            });

            renderUI();
        });

    </script>
</head>
<body class="min-h-screen">
    
    <!-- Global Alert Container --><div id="alert-container" class="fixed top-0 right-0 m-4 z-50 w-full max-w-sm">
        <!-- Alerts will be injected here --></div>

    <div class="acnh-card max-w-4xl mx-auto relative z-10">
        <!-- æ¨™é¡Œå·²ç§»é™¤ Emoji -->
        <h1 class="text-3xl sm:text-4xl text-center mb-3">ã€Šé›†åˆå•¦ï¼é›€å‹äº¤æµæœƒã€‹</h1>
        
        <!-- User ID: ACNH style display --><p id="user-id-display" class="text-center text-sm mb-6 p-2 rounded-xl border border-gray-300 bg-gray-50" style="color: var(--color-text-light);">æˆ‘çš„å³¶å¶¼è™Ÿç¢¼ (å…±äº«éµ): è¼‰å…¥ä¸­...</p>

        <!-- Current Scores Display: Grid is responsive by default --><section id="score-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <!-- Score Cards will be injected here by renderScores() -->
        </section>

        <!-- Main Action Buttons --><div class="flex flex-wrap justify-center gap-4 mb-8">
            <!-- UPDATED: Removed (3å®¶ä»˜) from the button text -->
            <button id="open-hu-split-selection" class="acnh-button green-main w-full sm:w-auto">
                <span class="text-xl mr-2">ğŸ¯</span> è‡ªæ‘¸çµç®—
            </button>
            <button id="open-custom-round-modal" class="acnh-button red-gang w-full sm:w-auto">
                <span class="text-xl mr-2">âœï¸</span> è‡ªå®šç¾©åˆ†æ•¸è®Šå‹•
            </button>
            <button id="open-setup-modal" class="acnh-button blue-main w-full sm:w-auto">
                <span class="text-xl mr-2">ğŸ‘¥</span> è¨­å®šå³¶æ°‘åç¨±
            </button>
            <button id="open-settings-modal" class="acnh-button gray-main w-full sm:w-auto">
                <span class="text-xl mr-2">âš™ï¸</span> éŠæˆ²è¨­å®š
            </button>
             <button id="open-chart-modal-btn" class="acnh-button gray-main w-full sm:w-auto">
                <span class="text-xl mr-2">ğŸ“ˆ</span> é¡¯ç¤ºåˆ†æ•¸èµ°å‹¢åœ–
            </button>
            <button id="reset-game-btn" class="acnh-button yellow w-full sm:w-auto">
                <span class="text-xl mr-2">ğŸï¸</span> é‡è¨­éŠæˆ²
            </button>
        </div>
        
        <!-- Gang Quick Action Buttons -->
        <div class="flex flex-wrap justify-center gap-3 mb-8 p-3 rounded-2xl border-2 border-red-300 bg-red-50">
            <h2 class="w-full text-center text-lg font-bold text-red-600 mb-2">å›ºå®šæ§“åˆ†æ“ä½œ (è¨­å®šå€¼)</h2>
            <button id="open-kai-gang-btn" class="acnh-button red-gang flex-grow sm:flex-grow-0">
                <span class="text-xl mr-1">âœ¨</span> é–‹æ§“ (1æ”¶1ä»˜)
            </button>
            <button id="open-ming-gang-btn" class="acnh-button red-gang flex-grow sm:flex-grow-0">
                <span class="text-xl mr-1">âšª</span> æ˜æ§“ (1æ”¶3ä»˜)
            </button>
            <button id="open-an-gang-btn" class="acnh-button red-gang flex-grow sm:flex-grow-0">
                <span class="text-xl mr-1">âš«</span> æš—æ§“ (1æ”¶3ä»˜)
            </button>
        </div>


        <!-- History Section (Styled as a separate scrollable document) -->
        <section class="bg-gray-100 p-6 rounded-3xl shadow-inner border border-gray-300">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-yellow-600" style="text-shadow: 1px 1px 0 #FFF;">è³‡ç”¢è½‰ç§»è¡¨ (æœ€è¿‘ 10 ç­†)</h2>
            <ul id="history-list">
                <!-- History list items will be injected here by renderHistory() -->
            </ul>
        </section>
    </div>
    
    <!-- MODALS SECTION -->
    
    <!-- Score Chart Modal -->
    <div id="chart-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-2xl border-4 border-blue-500 transform transition-all">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-600">ğŸ“ˆ å³¶æ°‘åˆ†æ•¸èµ°å‹¢åœ–</h3>
                <div class="relative h-96">
                    <canvas id="score-chart"></canvas>
                </div>
                <!-- æ›´æ–°æç¤ºæ–‡å­— -->
                <p class="text-sm text-gray-500 mt-4 text-center">X è»¸ç‚ºå°å±€ç´€éŒ„æ¬¡æ•¸ (åˆ»åº¦å·²éš±è—)ï¼ŒY è»¸ç‚ºç´¯ç©ç¸½åˆ†ã€‚</p>
                <div class="flex justify-end mt-6">
                    <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Score Round Modal (Used for Zimo or Complex Custom Pao) -->
    <div id="custom-round-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-red-500 transform transition-all">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-red-600">âœï¸ è‡ªå®šç¾©åˆ†æ•¸è®Šå‹• (é›¶å’Œçµç®—)</h3>
                <p class="mb-4 text-sm text-gray-600">è«‹è¼¸å…¥æ¯ä½å³¶æ°‘çš„å¯¦éš›è®Šå‹•åˆ†æ•¸ (è´å®¶ç‚ºæ­£ï¼Œè¼¸å®¶ç‚ºè² )ã€‚**ç¸½å’Œå¿…é ˆç‚ºé›¶**ã€‚</p>
                <div id="round-inputs-container" class="space-y-4 mb-4">
                    <!-- Dynamic player inputs injected -->
                </div>
                <div id="round-total-change" class="text-xl font-bold text-center mb-4 p-2 rounded-lg bg-gray-100">
                    åˆ†æ•¸ç¸½è®Šå‹•: 0
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="confirm-round-btn" class="acnh-button green-main w-full sm:w-auto" style="box-shadow: 0 4px 0 0 #4CAF50;">
                        ç¢ºèªä¸¦çµç®—
                    </button>
                    <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hu Split Selection Modal (Step 1: Choose Winner) -->
    <div id="hu-split-selection-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-green-500 transform transition-all">
                <h3 id="hu-split-title" class="text-2xl font-bold mb-4 border-b pb-2 text-green-600">ğŸ¯ è‡ªæ‘¸çµç®— - èª°è‡ªæ‘¸ï¼Ÿ</h3>
                <p class="mb-4 text-sm text-gray-600">å°‡ä½¿ç”¨ **1 æ”¶ 3 ä»˜** çš„æ–¹å¼çµç®—ï¼Œè´å®¶åˆ†æ•¸ = è¼¸å…¥åˆ†æ•¸ x 3ã€‚</p>
                <div id="hu-split-buttons" class="space-y-3 mb-6">
                    <!-- Dynamic player buttons injected -->
                </div>
                <div class="flex justify-end">
                    <button type="button" class="close-modal-btn acnh-button gray-main">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hu Split Input Modal (Step 2: Input Score) -->
    <div id="hu-split-input-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-green-500 transform transition-all">
                <h3 id="hu-split-input-title" class="text-2xl font-bold mb-4 border-b pb-2 text-green-600">ğŸ¯ è‡ªæ‘¸çµç®— - æ¯å®¶æ”¶å¤šå°‘ï¼Ÿ</h3>
                <form id="hu-split-form" onsubmit="window.applyHuSplitScores(event)" data-winner-id="">
                    <label for="hu-split-total" class="block text-lg font-medium text-var-text-dark mb-2">æ¯ä½è¼¸å®¶æ”¯ä»˜çš„åˆ†æ•¸ (X)</label>
                    <input type="number" id="hu-split-total" required min="1" step="1" oninput="window.calculateHuSplit(parseInt(document.getElementById('hu-split-form').dataset.winnerId))"
                           class="mt-1 block w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark font-bold text-2xl no-spinners focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 mb-4"
                           placeholder="ä¾‹å¦‚: 10, 20, 30 (è¼¸å®¶å„ä»˜)">
                    
                    <p id="hu-split-error" class="text-sm text-red-600 mb-4 hidden"></p>

                    <div class="flex justify-end space-x-3">
                        <button type="submit" id="confirm-hu-split-btn" class="acnh-button green-main w-full sm:w-auto" disabled>
                            ç¢ºèªçµç®—
                        </button>
                        <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Player Setup Modal (Kept for completeness) -->
    <div id="setup-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-blue-500 transform transition-all">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-600">ğŸ‘¥ å³¶æ°‘æ›´åæœå‹™</h3>
                <div id="setup-inputs-container" class="space-y-4 mb-4">
                    <!-- Dynamic name inputs injected -->
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="save-names-btn" class="acnh-button blue-main w-full sm:w-auto">
                        å„²å­˜åç¨±
                    </button>
                    <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal (Kept for completeness) -->
    <div id="settings-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-gray-500 transform transition-all">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-700">âš™ï¸ éŠæˆ²è¨­å®š</h3>
                
                <div class="space-y-6">
                    <!-- Unit Setting -->
                    <div>
                        <label for="setting-step-value" class="block text-lg font-medium text-var-text-dark mb-1">å–®ä½èª¿æ•´æ­¥é•· (Â±æŒ‰éˆ•)</label>
                        <select id="setting-step-value" class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 sm:text-lg">
                            <option value="1">1 (æœ€å°å–®ä½)</option>
                            <option value="10">10 (æ–¹ä¾¿å¿«é€Ÿèª¿æ•´)</option>
                        </select>
                    </div>

                    <!-- Gang/Zimo Scores -->
                    <h4 class="text-xl font-bold text-red-600 border-t pt-4">æ§“åˆ†è¨­å®š (è¼¸å…¥ç¸½é¡ï¼Œéå€æ•¸)</h4>
                    
                    <div>
                        <label for="setting-kai-gang" class="block text-base font-medium text-var-text-dark mb-1">âœ¨ é–‹æ§“ (1 æ”¶ 1 ä»˜) ç¸½é¡</label>
                        <input type="number" id="setting-kai-gang" min="1" step="1"
                            class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 sm:text-lg no-spinners">
                        <p class="text-sm text-gray-500 mt-1">é–‹æ§“è€…æ”¶åˆ°çš„ç¸½åˆ†æ•¸ã€‚ç”±å–®ç¨ä¸€ä½ç©å®¶æ”¯ä»˜æ­¤é‡‘é¡ã€‚</p>
                    </div>
                    
                    <div>
                        <label for="setting-ming-gang" class="block text-base font-medium text-var-text-dark mb-1">âšª æ˜æ§“ (1 æ”¶ 3 ä»˜) ç¸½é¡</label>
                        <input type="number" id="setting-ming-gang" min="3" step="3"
                            class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 sm:text-lg no-spinners">
                        <p class="text-sm text-gray-500 mt-1">æ˜æ§“è€…æ”¶åˆ°çš„ç¸½åˆ†æ•¸ã€‚ç”±å…¶é¤˜ä¸‰å®¶å¹³å‡æ”¯ä»˜æ­¤é‡‘é¡ (å¿…é ˆæ˜¯ 3 çš„å€æ•¸)ã€‚</p>
                    </div>

                    <div>
                        <label for="setting-an-gang" class="block text-base font-medium text-var-text-dark mb-1">âš« æš—æ§“ (1 æ”¶ 3 ä»˜) ç¸½é¡</label>
                        <input type="number" id="setting-an-gang" min="3" step="3"
                            class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 sm:text-lg no-spinners">
                        <p class="text-sm text-gray-500 mt-1">æš—æ§“è€…æ”¶åˆ°çš„ç¸½åˆ†æ•¸ã€‚ç”±å…¶é¤˜ä¸‰å®¶å¹³å‡æ”¯ä»˜æ­¤é‡‘é¡ (å¿…é ˆæ˜¯ 3 çš„å€æ•¸)ã€‚</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="window.saveSettings()" class="acnh-button blue-main w-full sm:w-auto">
                        å„²å­˜è¨­å®š
                    </button>
                    <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gang Action Modal (Receiver Selection - Used for Fixed Ming/An Gang) -->
    <div id="gang-action-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-red-500 transform transition-all">
                <h3 id="gang-action-title" class="text-2xl font-bold mb-4 border-b pb-2 text-red-600">æ§“åˆ†çµç®— - èª°æ”¶éŒ¢ï¼Ÿ</h3>
                <p class="mb-4 text-sm text-gray-600">é¸æ“‡å“ªä½å³¶æ°‘æ˜¯é–‹æ§“çš„è´å®¶ï¼ˆåˆ†æ•¸å·²åœ¨è¨­å®šä¸­é è¨­ï¼‰ã€‚</p>
                <div id="gang-action-buttons" class="space-y-3 mb-6">
                    <!-- Dynamic player buttons injected -->
                </div>
                <div class="flex justify-end">
                    <button type="button" class="close-modal-btn acnh-button gray-main">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Kai Gang Payer Selection Modal (Used for Kai Gang Step 2) -->
    <div id="kai-gang-payer-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-red-500 transform transition-all">
                <h3 id="kai-gang-payer-title" class="text-2xl font-bold mb-4 border-b pb-2 text-red-600">âœ¨ é–‹æ§“ - èª°ä»˜éŒ¢ï¼Ÿ</h3>
                <p class="mb-4 text-sm text-gray-600">é¸æ“‡ç”±å“ªä¸€ä½å³¶æ°‘å–®ç¨æ”¯ä»˜æ§“åˆ†çµ¦æ”¶éŒ¢è€…ã€‚</p>
                <div id="kai-gang-payer-buttons" class="space-y-3 mb-6">
                    <!-- Dynamic player buttons injected -->
                </div>
                <div class="flex justify-end">
                    <button type="button" class="close-modal-btn acnh-button gray-main">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal (Kept for completeness) -->
    <div id="reset-confirm-modal" class="modal hidden fixed inset-0 z-[60] overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.4);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content w-full max-w-md border-4 border-red-500 transform transition-all">
                <h3 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2 border-red-400">ğŸš¨ å³¶å¶¼é‡å•Ÿè­¦å‘Š</h3>
                <p class="mb-4" style="color: var(--color-text-dark);">
                    æ­¤æ“ä½œå°‡**æ¸…é™¤æ‰€æœ‰ç©åˆ†ã€æ§“åˆ†å’Œå°å±€ç´€éŒ„**ï¼Œå°±åƒæ¬åˆ°ä¸€åº§æ–°å³¶å¶¼ä¸€æ¨£ã€‚
                </p>
                <p class="mb-2 font-medium" style="color: var(--color-text-dark);">
                    è«‹è¼¸å…¥ <code class="text-red-500 font-bold">HELLO KIWI</code> é€²è¡Œç¢ºèªï¼š
                </p>
                <input type="text" id="reset-verification-input"
                       class="mt-1 block w-full px-4 py-2 bg-gray-100 border border-red-400 rounded-lg text-var-text-dark focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 sm:text-lg mb-6"
                       placeholder="è¼¸å…¥ HELLO KIWI">
                <div class="flex justify-end space-x-3">
                    <button id="confirm-reset-btn" class="acnh-button yellow w-full sm:w-auto" style="background-color: #F44336; box-shadow: 0 4px 0 0 #D32F2F;">
                        ç¢ºèªé‡å•Ÿ
                    </button>
                    <button type="button" class="close-modal-btn acnh-button gray-main w-full sm:w-auto">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
